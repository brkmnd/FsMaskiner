<!DOCTYPE html>
<html>
<head>
<style>
.komponent {display:none;}
</style>
</head>
<body>
<span class="komponent" id="komp-js-stack">var Stack = function(){
    var stack = {};
    var len = 0;
    var pub = {};
    pub.push = function(v0){
        if(stack[len] !== undefined){
            stack[len].val = v0;
        }
        else {
            stack[len] = {val:v0};
            }
        len++;
        };
    pub.pop = function(){
        if(len > 0){
            len--;
            return stack[len].val;
            }
        return null;
        };
    pub.popN = function(n,f){
        var n0 = n;
        while(len > 0 && n0 > 0){
            f(this.pop());
            n0--;
            }
        };
    pub.peek = function(){
        if(len > 0){
            return stack[len - 1].val;
            }
        return null;
        };
    pub.foreach = function(f){
        var i = len - 1;
        while(i >= 0){
            f(stack[i].val);
            i--;
            }
        };
    pub.count = function(){
        return len;
        };
    return pub;
    };
</span>
<span class="komponent" id="komp-js-type">var actionType = {
    shift:function(d){
        return {type:"shift",v:d};
        },
    reduce:function(d){
        return {type:"reduce",v:d};
        },
    accept:function(d){
        return {type:"accept",v:null};
        },
    error:function(msg){
        return {type:"error",v:msg};
        },
    none:function(){
        return {type:"none",v:null};
        },
    some:function(v){
        return {type:"some",v:v}
        }
    };
var isSome = function(m){
    return m.t === "some";
    };
var isNone = function(m){
    return m.t === "none";
    };
</span>
<span class="komponent" id="komp-js-tokens-hoved">var _token = function(m,o){
    //m.tv = token val
    //m.t = some/none
    //m.v = value if some, else null
    if(o[m.tv] !== undefined){
        return o[m.tv](m.tv,m.v);
        }
    };
var addToken2tree = function(tree,node){
    _token(node,{
</span>
<span class="komponent" id="komp-js-tokens-bund">       });
    return tree;
    };
</span>
<span class="komponent" id="komp-js-errors">var errors = {
    syntax:function(pos,msg){
        return "syntax error at (" + pos.y + "," + pos.x + "):" + msg;
        },
    garbage:function(g){
        return "garbage in expression: '" + g + "'";
        }
    };
</span>
<span class="komponent" id="komp-js-lexer-hoved">var lexer = function(inStr){
</span>
<span class="komponent" id="komp-js-lexer-regex">    var rx = new RegExp(rxStr,"g");
    var retI = 0;
    var retval = {};
    var linepos = {lnr:1,start:0};
</span>
<span class="komponent" id="komp-js-lexer-ret">    if(resStr !== ""){
        retval["__success"] = false;
        retval["__res"] = resStr;
        }
    else {
        retval[retI] = {t:"none",v:null,tv:"$"};
        }
    return retval;
    };
</span>
<span class="komponent" id="komp-js-parser">var parser = function(tokens){
    var sStack = new Stack();
    var tree = new Stack();
    var i = 0;
    var parsing = true;
    if(tokens["__success"] !== undefined && !tokens["__success"]){
        tree.push({error:true,msg:errors.garbage(tokens["__res"])});
        return tree;
        }
    sStack.push(0);
    while(parsing){
        var s = sStack.peek();
        var a = tokens[i].tv;
        var entry = actionTable[s][a];
        switch(entry.type){
            case "shift":
                sStack.push(entry.v);
                tree = addToken2tree(tree,tokens[i]);
                i += 1;
                break;
            case "reduce":
                var r = entry.v;
                var prod = productions_str[r];
                var rSide = prod.rside;
                var pName = prod.prod;
                var pFun = productions_fun[r];
                sStack.popN(rSide.length,function(x){});
                sStack.push(gotoTable[sStack.peek()][pName].v);
                tree = pFun(tree);
                break;
            case "accept":
                return tree;
            case "error":
                var token = tokens[i];
                tree.push({error:true,msg:errors.syntax({x:token.posX,y:token.posY},entry.v)});
                return tree;
            }
        }
    };
</span>
<center>
<textarea id="tekst-ud" style="display:block;width:800px;height:800px;background-color:white;color:black;border:1px solid black;"></textarea>
</center>
<script src="tableout.js"></script>
<script>
    var tekstUd = document.getElementById("tekst-ud");
    var indent1 = "    ";
    var indent2 = indent1 + indent1;
    var indent3 = indent1 + indent2;
    var indent4 = indent2 + indent2;
    var nonTerms = function(){
        var retval = [];
        var i = 0;
        while(productions_str[i] !== undefined){
            var prodN = productions_str[i].prod;
            if(prodN !== "__" && retval.indexOf(prodN) < 0){
                retval.push(prodN);
                }
            i++;
            }
        return retval;
        }();
    var lang_js = {
        shift:function(v){
            return "actionType.shift(" + v.toString() + ")";
            },
        reduce:function(v){
            return "actionType.reduce(" + v.toString() + ")";
            },
        error:function(v){
            return "actionType.error(\"" + v + "\")";
            },
        accept:function(){
            return "actionType.accept()";
            },
        some:function(v){
            return "actionType.some(" + v.toString() + ")";
            },
        none:function(){
            return "actionType.none()";
            }
        };

    var komponenterJS = function(){
        var komp_stack = document.getElementById("komp-js-stack");
        var komp_type = document.getElementById("komp-js-type");
        var komp_tokens_hoved = document.getElementById("komp-js-tokens-hoved");
        var komp_tokens_krop = function(){
            var retstr = "";
            for(var i = 0; i < tokens.length; i++){
                var token = tokens[i];
                if(token.cap){
                    retstr += indent2;
                    retstr += "\"" + token.name + "\":";
                    retstr += "function(tokenV,capV){ /* do something to tree */ },\n";
                    }
                }
            return retstr.substr(0,retstr.length - 2) + "\n";
            }();
        var komp_tokens_bund = document.getElementById("komp-js-tokens-bund");
        var komp_errors = document.getElementById("komp-js-errors");
        var komp_lexer_hoved = document.getElementById("komp-js-lexer-hoved");
        var komp_lexer_regex = document.getElementById("komp-js-lexer-regex");
        var komp_lexer_ret = document.getElementById("komp-js-lexer-ret");
        var komp_parser = document.getElementById("komp-js-parser");
        return {
            stack:komp_stack.innerHTML,
            type:komp_type.innerHTML,
            tokens:komp_tokens_hoved.innerHTML + komp_tokens_krop + komp_tokens_bund.innerHTML,
            errors:komp_errors.innerHTML,
            lexer_hoved:komp_lexer_hoved.innerHTML,
            lexer_regex:komp_lexer_regex.innerHTML,
            lexer_ret:komp_lexer_ret.innerHTML,
            parser:komp_parser.innerHTML
            }
        };
    var tabellerJS = function(){
        var intTokens = function(){
            var retval = [];
            for(var i = 0; i < tokens.length; i++){
                retval.push(tokens[i].name)
                }
            retval.push("$");
            return retval;
            }();
        var tabel_action = function(){
            var retstr = "var actionTable = {\n";
            var i0 = 0;
            while(actionTable[i0] !== undefined){
                retstr += indent1 + i0.toString() + ":{\n";
                for(var j = 0; j < intTokens.length; j++){
                    var tokenName = intTokens[j];
                    retstr += indent2;
                    retstr += "\"" + tokenName + "\":";
                    retstr += actionTable[i0][tokenName](lang_js);
                    retstr += ",\n";
                    }
                retstr = retstr.substr(0,retstr.length - 2) + "\n";
                retstr += indent2 + "},\n";
                i0++;
                }
            return retstr.substr(0,retstr.length - 2) + "\n" + indent1 + "};\n";
            }();
        var tabel_goto = function(){
            var retstr = "var gotoTable = {\n";
            var i = 0;
            while(gotoTable[i] !== undefined){
                var g = gotoTable[i];
                retstr += indent1 + i.toString() + ":{\n";
                for(var j = 0; j < nonTerms.length; j++){
                    var term = nonTerms[j];
                    retstr += indent2;
                    retstr += "\"" + term + "\":";
                    retstr += gotoTable[i][term](lang_js);
                    retstr += ",\n";
                    }
                retstr  = retstr.substr(0,retstr.length - 2) + "\n";
                retstr += indent2 + "},\n";
                i++;
                }
            return retstr.substr(0,retstr.length - 2) + "\n" + indent1 + "};\n";
            }();
        var tabel_prod_fun = function(){
            var retstr = "var productions_fun = {\n";
            var i = 0;
            while(productions_str[i] !== undefined){
                var prod = productions_str[i];
                var lside = prod.prod;
                var rside = prod.rside;
                retstr += indent1;
                retstr += "//[" + i.toString() + "] ";
                retstr += lside;
                retstr += " -> ";
                for(var j = 0; j < rside.length; j++){
                    retstr += rside[j] + " ";
                    }
                retstr += "\n";
                retstr += indent1 + i.toString() + ":";
                retstr += "function(tree){ return tree; },";
                retstr += "\n";
                i++
                }
            return retstr.substr(0,retstr.length - 2) + "\n" + indent1 + "};\n";
            }();
        var tabel_prod_str = function(){
            var retstr = "var productions_str = {\n";
            var i = 0;
            while(productions_str[i] !== undefined){
                var prod = productions_str[i];
                var lside = prod.prod;
                var rside = prod.rside;
                retstr += indent1;
                retstr += i.toString() + ":";
                retstr += "{prod:\"" + lside + "\",";
                retstr += "rside:[ ";
                for(var j = 0; j < rside.length; j++){
                    retstr += "\"" + rside[j] + "\",";
                    }
                retstr  = retstr.substr(0,retstr.length - 1);
                retstr += "]},\n";
                i++;
                }
            return retstr.substr(0,retstr.length - 2) + "\n" + indent1 + "};\n";
            }();
        return {
            action:tabel_action,
            goto:tabel_goto,
            prod_fun:tabel_prod_fun,
            prod_str:tabel_prod_str
            };
        };
    var lexerJS = function(){
        var rx_str = function(){
            var escTegn = function(t){
                var rx = new RegExp("\\/|\\.|\\(|\\)|\\\\","g");
                return t.replace(rx,function(a){
                    if(a === "\\"){
                        return "\\" + a;
                        }
                    return "\\\\" + a;
                    });
                };
            var retstr = indent1;
            retstr += "var rxStr =\n";
            for(var i = 0; i < tokens.length; i++){
                retstr += indent2;
                retstr += "\"(" + escTegn(tokens[i].reg) + ")|\"+\n";
                }
            for(var i = 0; i < btokens.length; i++){
                retstr += indent2;
                retstr += "\"" + btokens[i] + "|\"+\n";
                }
            return retstr.substr(0,retstr.length - 4) + "\";\n";
            }();
        var rx_fun = function(){
            var retstr = indent1;
            retstr += "var resStr = inStr.replace(rx,\n";
            retstr += indent2;
            retstr += "function(a,";
            for(var i = 0; i < tokens.length; i++){
                retstr += "i" + (i + 1).toString() + ",";
                }
            retstr  = retstr.substr(0,retstr.length - 1) + ",posX){\n";
            retstr += indent3 + "if(a === \"\\n\"){\n";
            retstr += indent4 + "linepos.lnr++;\n";
            retstr += indent4 + "linepos.start = posX;\n";
            retstr += indent4 + "}\n";
            for(var i = 0; i < tokens.length; i++){
                var statement = function(){
                    if(i === 0){
                        return "if";
                        }
                    else {
                        return "else if";
                        }
                    }();
                var option = function(){
                    if(tokens[i].cap){
                        return "\"some\"";
                        }
                    return "\"none\"";
                    }();
                retstr += indent3;
                retstr += statement + "(";
                retstr += "typeof i" + (i + 1).toString();
                retstr += " !== ";
                retstr += "\"undefined\"){\n";
                retstr += indent4;
                retstr += "retval[retI] = {";
                retstr += "t:" + option + ",";
                retstr += "tv:" + "\"" + tokens[i].name + "\",";
                retstr += "posX:posX - linepos.start,";
                retstr += "posY:linepos.lnr";
                retstr += "};\n";
                retstr += indent4;
                retstr += "retI++;\n";
                retstr += indent4;
                retstr += "}\n";
                }
            retstr += indent3 + "return \"\";\n";
            retstr += indent3 + "}\n";
            retstr += indent2 + ");\n";
            return retstr;
            }();
        return {
            rx_str:rx_str,
            rx_fun:rx_fun
            };
        };
    var domParser = new DOMParser;
    var tabeller = tabellerJS();
    var lexer = lexerJS();
    var komponenter = komponenterJS();
    var add2tekst = function(v){
        var rx = new RegExp("&amp;|&gt;|&lt;","g");
        var decoded = v.replace(rx,function(a){
            if(a === "&amp;"){
                return "&"
                }
            if(a === "&gt;"){
                return ">";
                }
            if(a === "&lt;"){
                return "<";
                }
            return a;
            });
        tekstUd.value += decoded;
        }
    //misc
    add2tekst(komponenter.stack);
    add2tekst(komponenter.type);
    add2tekst(komponenter.tokens);
    add2tekst(komponenter.errors);
    
    //prods
    add2tekst(tabeller.prod_fun);
    add2tekst(tabeller.prod_str);
   
    //lexer
    add2tekst(komponenter.lexer_hoved);
    add2tekst(lexer.rx_str);
    add2tekst(komponenter.lexer_regex);
    add2tekst(lexer.rx_fun);
    add2tekst(komponenter.lexer_ret);
    
    //tabeller
    add2tekst(tabeller.action);
    add2tekst(tabeller.goto);
    //parser
    add2tekst(komponenter.parser);
</script>
</body>
</html>
